<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PERRAN SUD</title>

<style>
body{
  margin:0;
  font-family:"Comic Sans MS",system-ui,sans-serif;
  background:linear-gradient(135deg,#ff0080,#7928ca);
  color:#fff;
  text-align:center;
}
.page{display:none;padding:12px 10px 190px}
.page.active{display:block}

button{
  border:none;border-radius:20px;
  padding:16px;font-size:20px;
  margin:6px;cursor:pointer;
}
button:disabled{opacity:.4}

.big{
  font-size:60px;
  width:140px;height:140px;
  font-weight:bold;
}

.stack{display:flex;flex-direction:column;align-items:center;gap:6px}
.message{font-size:20px;min-height:44px}
.counter{font-size:18px}

/* Animations */
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
@keyframes shake{0%{transform:rotate(0)}25%{transform:rotate(6deg)}50%{transform:rotate(-6deg)}75%{transform:rotate(6deg)}100%{transform:rotate(0)}}
@keyframes rage{
  0%{transform:scale(1)}
  25%{transform:scale(1.3) rotate(10deg)}
  50%{transform:scale(1.3) rotate(-10deg)}
  75%{transform:scale(1.3) rotate(10deg)}
  100%{transform:scale(1)}
}
.animate{animation:pulse .25s,shake .25s}
.rage{animation:rage .45s}

/* Badge dÃ©rapage */
#derapage{
  display:none;
  background:#ff0000;
  padding:10px 18px;
  border-radius:30px;
  font-size:18px;
  font-weight:bold;
  margin-bottom:8px;
  animation:pulse .8s infinite;
}

.stat-box{
  background:rgba(0,0,0,.35);
  margin:8px;
  padding:10px;
  border-radius:14px;
  font-size:17px;
}

nav{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;display:flex;z-index:10;
}
nav button{flex:1;background:none;color:#fff}

#app-signature{
  position:fixed;bottom:52px;left:0;right:0;
  font-size:12px;opacity:.85;z-index:1000;
}

#pseudoInput{
  font-size:18px;padding:14px;border-radius:18px;
  border:none;text-align:center;
  font-weight:bold;text-transform:uppercase;
  width:80%;max-width:300px;
  box-shadow:0 0 0 3px rgba(255,255,255,0.6);
}
.confirm{background:#ff0000}
</style>
</head>

<body>

<div id="app-signature">By Jean-Jesus Bernardo De Perran</div>

<!-- LOGIN -->
<div id="page-login" class="page">
  <h1>PERRAN SUD</h1>
  <p>Entre ton pseudo ğŸ»</p>
  <input id="pseudoInput" placeholder="PSEUDO">
  <br><br>
  <button id="enterBtn" onclick="savePseudo()" disabled>ENTRER</button>
</div>

<!-- ACTION -->
<div id="page-action" class="page">
  <h2 id="welcome"></h2>
  <div id="derapage">ğŸš¨ MODE DÃ‰RAPAGE ğŸš¨</div>

  <div class="stack">
    <div class="message" id="beerMessage">ğŸº</div>
    <button id="beerBtn" class="big" style="background:#ffcc00" onclick="addBeer()">ğŸº</button>
    <div class="counter">Verres : <span id="beerCount">0</span></div>

    <div class="message" id="smokeMessage">ğŸš¬</div>
    <button id="smokeBtn" class="big" style="background:#00ffcc" onclick="addSmoke()">ğŸš¬</button>
    <div class="counter">Clopes : <span id="smokeCount">0</span></div>
  </div>
</div>

<!-- STATS -->
<div id="page-stats" class="page">
  <h2>ğŸ“Š Statistiques</h2>
  <div id="stats"></div>
</div>

<!-- RESET -->
<div id="page-reset" class="page">
  <h2>âš™ï¸ Remise Ã  zÃ©ro</h2>
  <button class="confirm" onclick="resetPeriod('day')">RAZ JournÃ©e</button><br>
  <button class="confirm" onclick="resetPeriod('week')">RAZ Semaine</button><br>
  <button class="confirm" onclick="resetPeriod('month')">RAZ Mois</button><br>
  <button class="confirm" onclick="resetPeriod('year')">RAZ AnnÃ©e</button><br>
  <button class="confirm" onclick="deleteAccount()">SUPPRIMER LE COMPTE</button>
</div>

<nav>
  <button onclick="showPage('action')">ğŸº</button>
  <button onclick="showPage('stats')">ğŸ“Š</button>
  <button onclick="showPage('reset')">âš™ï¸</button>
</nav>

<script>
/* ===== LOGIN ===== */
const input=pseudoInput, enterBtn=document.getElementById("enterBtn");
input.addEventListener("input",()=>{
  input.value=input.value.toUpperCase();
  enterBtn.disabled=input.value.trim()==="";
});
input.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!enterBtn.disabled)savePseudo();
});

/* ===== AUDIO ===== */
let ctx;
function audioCtx(){
  if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)();
  return ctx;
}
function playTrumpet(power){
  const c=audioCtx(),o=c.createOscillator(),g=c.createGain();
  o.type="square";
  o.frequency.setValueAtTime(power?900:520,c.currentTime);
  g.gain.setValueAtTime(0.001,c.currentTime);
  g.gain.exponentialRampToValueAtTime(0.6,c.currentTime+0.05);
  g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.3);
  o.connect(g);g.connect(c.destination);
  o.start();o.stop(c.currentTime+0.3);
}
function playExplosion(power){
  const c=audioCtx();
  const b=c.createBuffer(1,c.sampleRate*0.6,c.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length);
  const n=c.createBufferSource(),g=c.createGain();
  n.buffer=b;
  g.gain.setValueAtTime(power?1.4:1,c.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.6);
  n.connect(g);g.connect(c.destination);
  n.start();n.stop(c.currentTime+0.6);
}

/* ===== DATA ===== */
let data=JSON.parse(localStorage.getItem("perranData"))||{history:[]};
const save=()=>localStorage.setItem("perranData",JSON.stringify(data));

/* ===== MESSAGES ===== */
const beerMsgs=[
  "TCHIN !","JAMAIS SUR DEUX PATTES","TU NE CONDUIS PAS DE SUITE",
  "OK TU BOIS QUOI ?","Câ€™EST FÃŠTE ?","ON VA CHANTER ?",
  "LES OIES SAUVAGES !!","TU PARLES Ã‰GYPTIEN",
  "Tâ€™AS OUBLIÃ‰ LES CONSONNES","Tâ€™AS VOMI SUR TES POMPES",
  "Câ€™EST BON Tâ€™ES SEC"
];
const smokeMsgs=[
  "ACCRO ?","ENCORE UNE ?","COMBIEN TU VAS EN FUMER ?",
  "Tâ€™AS TON QUOTA","Câ€™EST JUSTE RAISONNABLE","TU TOUSSES TONTON",
  "TA LANGUE EST JAUNE","GAINSBOURG STYLE",
  "TAIN*** ENCORE ?","Tâ€™Y LAISSES TA PAYE",
  "VA TE LAVER LES POUMONS","TU PUES DU BEC","HALEINE DE TRAPPEUR"
];

/* ===== DATES / STATS ===== */
const startDay=d=>new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();
const startWeek=d=>{let x=new Date(d);x.setHours(0,0,0,0);let n=x.getDay()||7;x.setDate(x.getDate()-n+1);return x.getTime();}
const startMonth=d=>new Date(d.getFullYear(),d.getMonth(),1).getTime();
const startYear=d=>new Date(d.getFullYear(),0,1).getTime();

const count=(type,from,to)=>data.history.filter(e=>e.type===type&&e.time>=from&&e.time<=to).length;

function getStats(){
  const n=new Date();
  return{
    today:{b:count("beer",startDay(n),Date.now()),s:count("smoke",startDay(n),Date.now())},
    yesterday:{b:count("beer",startDay(new Date(n-86400000)),startDay(n)),
               s:count("smoke",startDay(new Date(n-86400000)),startDay(n))},
    week:{b:count("beer",startWeek(n),Date.now()),s:count("smoke",startWeek(n),Date.now())},
    month:{b:count("beer",startMonth(n),Date.now()),s:count("smoke",startMonth(n),Date.now())},
    year:{b:count("beer",startYear(n),Date.now()),s:count("smoke",startYear(n),Date.now())}
  };
}
function renderStats(){
  const s=getStats();
  stats.innerHTML=`
    <div class="stat-box">Aujourdâ€™hui ğŸº ${s.today.b} / ğŸš¬ ${s.today.s}</div>
    <div class="stat-box">Hier ğŸº ${s.yesterday.b} / ğŸš¬ ${s.yesterday.s}</div>
    <div class="stat-box">Semaine ğŸº ${s.week.b} / ğŸš¬ ${s.week.s}</div>
    <div class="stat-box">Mois ğŸº ${s.month.b} / ğŸš¬ ${s.month.s}</div>
    <div class="stat-box">AnnÃ©e ğŸº ${s.year.b} / ğŸš¬ ${s.year.s}</div>`;
}

/* ===== MODE DÃ‰RAPAGE ===== */
function updateDerapage(){
  const s=getStats().today;
  derapage.style.display = (s.b>=10 || s.s>=10) ? "block" : "none";
}

/* ===== NAV ===== */
function savePseudo(){
  data.pseudo=input.value.trim();
  save();init();
}
function showPage(p){
  if(!data.pseudo&&p!=="login"){alert("Pseudo obligatoire");return;}
  document.querySelectorAll(".page").forEach(e=>e.classList.remove("active"));
  document.getElementById("page-"+p).classList.add("active");
  if(p==="stats") renderStats();
}

/* ===== ACTIONS ===== */
function vibrate(pattern){
  if(navigator.vibrate) navigator.vibrate(pattern);
}
function animate(btn,c){
  btn.classList.remove("animate","rage");
  void btn.offsetWidth;
  if(c>=10){
    btn.classList.add("rage");
    vibrate([100,50,100,50,200]);
  }else{
    btn.classList.add("animate");
    vibrate(50);
  }
  updateDerapage();
}

function addBeer(){
  data.history.push({type:"beer",time:Date.now()});
  const c=getStats().today.b;
  beerMessage.innerText=beerMsgs[Math.min(c-1,beerMsgs.length-1)];
  beerCount.innerText=c;
  playTrumpet(c>=6);
  animate(beerBtn,c);
  save();
}
function addSmoke(){
  data.history.push({type:"smoke",time:Date.now()});
  const c=getStats().today.s;
  smokeMessage.innerText=smokeMsgs[Math.min(c-1,smokeMsgs.length-1)];
  smokeCount.innerText=c;
  playExplosion(c>=6);
  animate(smokeBtn,c);
  save();
}

/* ===== RESET ===== */
function resetPeriod(type){
  if(!confirm("Confirmer ?"))return;
  const n=new Date();
  const from={day:startDay(n),week:startWeek(n),month:startMonth(n),year:startYear(n)}[type];
  data.history=data.history.filter(e=>e.time<from);
  save();init();
}
function deleteAccount(){
  if(confirm("SUPPRIMER ?")){
    localStorage.clear();
    location.reload();
  }
}

function init(){
  if(!data.pseudo){
    showPage("login");
  }else{
    welcome.innerText="SALUT "+data.pseudo+" ğŸ»";
    beerCount.innerText=getStats().today.b;
    smokeCount.innerText=getStats().today.s;
    updateDerapage();
    showPage("action");
  }
}
init();
</script>

</body>
</html>
